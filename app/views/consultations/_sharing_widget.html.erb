<% sharing = @consultation.consultation_sharing %>

<div class="p-4 border rounded-lg bg-white shadow-sm">
  <% if sharing.present? %>
    <%# 共有データがある場合（QRコード表示） %>
    <%# shared_consultation_url は config/routes.rb で定義したパスヘルパー %>
    <% shared_url = shared_consultation_url(token: sharing.shared_token) %>
    
    <div class="text-center">
      <p class="font-bold text-lg text-green-700 mb-2">スキャンしてカルテを共有</p>
      
      <%# --- QRコードの描画エリア --- %>
      <div class="my-4 inline-block p-2 border-4 border-gray-200">
        <%= qrcode (shared_url) %>
      </div>
      <%# --- 描画エリア終了 --- %>
      
      <p class="text-sm mt-4 text-gray-600">
        有効期限: <span class="font-semibold"><%= sharing.expires_at.strftime("%Y年%m月%d日 %H:%M") %></span>まで
      </p>
      <p class="text-xs mt-1 text-blue-500 truncate" title="<%= shared_url %>">
        リンク: <%= shared_url %>
      </p>
    </div>

  <% else %>
    <%# 共有データがない場合（ボタン表示） %>
    <%= button_to '共有リンクを生成する', consultation_sharings_path(consultation_id: @consultation.id), 
                  method: :post, 
                  class: 'w-full py-3 bg-blue-600 text-white font-bold rounded-md hover:bg-blue-700 transition',
                  data: { turbo_frame: 'sharing_widget' } %>
  <% end %>
</div>
